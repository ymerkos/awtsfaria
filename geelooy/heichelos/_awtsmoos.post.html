<!--B"H-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awtsmoos POST</title>
    <link rel="stylesheet" href="/heichelos/new-style.css" type="text/css">

    <link rel="stylesheet" href="/style/home/main.css">
</head>

<body>
    
    <div class="all">
        <?<script> return $a("nav/header.html") 
        </script>?>
 <div class="main">
<div class="post-view">
    
   

    

    <div class="container">
        <div class="post">
            <div class="post-header">
                
                <div class="post-title" id="postTitle">
                   
                </div>
                <div class="controls btns">

                    <button id="minMax" class="button primary">A</button>

                    <button id="commentaryBtn" class="button third">i</button>
                </div>
                <div class="post-details hidden-details" id="postDetails">

                    
                    <div class="settings"> <!-- Controls for Text Size -->
                        <div class="controls">
                            <button onclick="adjustFontSize('increase')" class="button secondary">Increase Text Size</button>
                            <button onclick="adjustFontSize('decrease')" class="button secondary">Decrease Text Size</button>
                        </div>
                    </div>
                    
                </div>
                
                
                    
            </div>
            
            
            <div id="postFrame" class="post-frame">
                <div class="content" id="realPost">Loading..
                </div>
                <div class="sidebar hidden-comments">
                    <div class="tab-buttons">
                          </div>
                    <div class="all-tabs">
                        
                    </div>
                </div>
        </div>
            
            
            <script>
                 
                console.log("B\"H");

                //<?Awtsmoos
                    return `
                        var heichel = "${heichel}";
                        var parentSeries = "${parentSeries}"
                        var indexInSeries = ${indexInSeries}
                    `;
                //?>
                var alias = null;
                async function startItAll() {
                    var series = await getSeries(parentSeries)
                    var post = await getPost(series, indexInSeries, heichel);
                    window.series = series;
                    if(post) {

                        var heichelDetails = await getHeichelDetails(heichel)
                        post.heichel = {
                            id: heichel,
                            ...heichelDetails
                        };


                        window.post = post;
                        var aliasDetails = await getAliasName(post.author)
                        alias = {
                            id: post.author,
                            ...aliasDetails
                        }
                        var html = makeNavBars(post, series, indexInSeries)
                        realPost.innerHTML = post.content + html;
                        postTitle.textContent = post.title;
                        var t = document.getElementsByTagName("title")[0]
                        if(t) {
                            t.innerHTML += "| " +post.title
                        }
                    } else {
                        post.innerHTML = "Couldn't load post"
                    }
                    addTab({
                        header: "Post Info",
                        content: makeInfoHTML()
                        
                        
                        
                    });
                    


                    addTab({
                        header: "Connections",
                        content: "Coming soon iy\"H!"
                    });
                }

                async function getHeichelDetails(heichelId) {
                    return await getAPI(`https://awtsmoos.com/api/social/heichelos/${
                        heichelId
                    }`)
                }

                async function getAliasName(alias) {
                    return await getAPI(`https://awtsmoos.com/api/social/aliases/${
                        alias
                    }`)
                }
                async function getSeries(id) {
                    var seriesData = await getAPI(
                        `https://awtsmoos.com/api/social/heichelos/${
                            heichel
                        }/series/${parentSeries}/details` 
                    );
                    return seriesData;
                }
                async function getPost(parentSeries, index, heichel) {
                    

                    var p = parentSeries.posts[index];
                    if(!p) return null;

                    var postInfo =  await getAPI(
                        `https://awtsmoos.com/api/social/heichelos/${
                            heichel
                        }/post/${p}` 
                    );

                    return postInfo

                }

                async function getAPI(url) {
                    try {
                        var r = await fetch(url)
                        var t = await r.text();
                        try {
                            t = JSON.parse(t)
                        } catch(e){}
                        return t;
                    } catch(e) {
                        return null;
                    }
                }

                var postElement = postFrame;
                var MAX_FONT_SIZE = 45;  // Define the max font size
                var MIN_FONT_SIZE = 10;  // Define the min font size
                var FONT_SIZE_INCREMENT = 2; // Define the size increment
                var postElement;
                function adjustFontSize(action) {
                    if(!postElement)
                        postElement = document.querySelector('.content');
                    let currentFontSize = window.getComputedStyle(postElement, null).getPropertyValue('font-size');
                    currentFontSize = parseFloat(currentFontSize);
                
                    if(action =='increase' && currentFontSize < MAX_FONT_SIZE) {
                        postElement.style.fontSize = (currentFontSize + FONT_SIZE_INCREMENT) + 'px';
                    } else if(action === 'decrease' && currentFontSize > MIN_FONT_SIZE) {
                        postElement.style.fontSize = (currentFontSize - FONT_SIZE_INCREMENT) + 'px';
                    }
        
                    localStorage.currentFontSize = currentFontSize;
                   // sendSizeMessage()
                }

                function loadFontSize() {
                    if(!postElement)
                        postElement = document.querySelector('.content');
                    if(!postElement) {
                        return;
                    }
                    var fs = localStorage.currentFontSize;
                    if(!fs) return;
                    var num = parseInt(fs);
                    if(isNaN(num)) return;
                    postElement.style.fontSize = num +"px";

                }

                onload = async () => {
                    await startItAll()
                    loadFontSize()
                }
                var $_GET= new URLSearchParams(location.search)


                function makeInfoHTML(){
                    var html="";
                    
                    html += `<div class="tl post-author"><div class="label">Author:</div>
                            <div class="value"><a href="/@${
                                alias.id
                                
                                }">${alias.name}</a></div></div>
                            <div class="tl post-heichel-name"><div class="label">Heichel Name:</div>
                            <div class="value"><a href="/heichelos/${
                                post.heichel.id
                            }">${post.heichel.name}
                            </a></div></div>`;
                    
                    var pth = $_GET.get("path")
                    var sr = parentSeries;
                    html +=`<div class="tl post-parent-series">
                            <div class="label">Part of Series:</div>
                            <div class="value"><a href="/heichelos/${
                                post.heichel.id   
                            }/#?series=${
                                sr + (pth ? "&path="+pth : "")
                            }">${series.prateem.name}</a>
                        </div>
                        </div>`
                    return html;

                }


                function makeNavBars(post, seriesParent, indexInSeries) {
                    var html = "";
                    var myID = post.id;
                    var sr = seriesParent.id;
                
                    var posts = seriesParent.posts
                    var cur = indexInSeries
                    var length = posts.length;
                    
                    var hasPrevious = cur > 0;
                    var hasNext = cur < length - 1;
                  
                    var path = null
                    html += `<div class="nav">`

                    html+= `<div class="controls">${
                            cur + 1
                        } of ${
                            length
                        }    
                        </div>`;
                    var last = encodeURIComponent(cur-1);
                    if(hasPrevious) {
                        html += 
                        `<a id="last" class="nav button primary" href="${last}">Previous</a>`
                    }

                    if(hasNext) {
                        var next = encodeURIComponent(cur+1);
                        html += 
                        `<a id="next" class="nav button primary"  href="${next}">Next</a>`
                    }

                    html += `</div>`;

                    html += `
                        <script>

                            if(window.next) {
                                next.href = next.href
                                
                            }

                            if(window.last) {
                                last.href = last.href
                                    
                            }
                        </script` + `>`;
                    return html;
                }


            
            
        
                var hidSettings = true;
                var hidCom = true;
                var sidebar = document.querySelector(".sidebar");
                
                var allTabs = document.querySelector(".all-tabs");
                var allTabBtns = document.querySelector(".tab-buttons");

                


                
                minMax.onclick = () => {
                    postFrame.classList.toggle("with-details")
                    postDetails.classList.toggle("hidden-details")
                    hidSettings = !hidSettings;
                    minMax.classList.toggle("pushed")
                 //   minMax.textContent = hid ? "+" : "-"
                }
                commentaryBtn.onclick = () => {
                    hidCom = !hidCom;
                    commentaryBtn.classList.toggle("pushed")
                    
                ///.innerHTML = hidCom ? "+" : "-";
                    sidebar.classList.toggle("hidden-comments")
                }


                

                

                function addTab({
                  
                    header,
                    content
                }) {
                    if(
                        !sidebar ||
                        !allTabs ||
                        !allTabBtns
                    ) return;
                    var btn =document.createElement("div");
                    btn.className = "tab-button"
                    allTabBtns.appendChild(btn);
                    btn.textContent = header;

                    var tab = document.createElement("div");
                    tab.className="tab-container";
                    allTabs.appendChild(tab);

                    var info  =document.createElement("div")
                    info.className="post-info";
                    tab.appendChild(info)

                    var bck = document.createElement("div");
                    bck.className = "back-btn";
                    bck.textContent = "Back";
                    info.appendChild(bck);

                    var hdr = document.createElement("div");
                    hdr.className = "info-header";
                    hdr.textContent = header;
                    info.appendChild(hdr);

                    var actualTab = document.createElement("div");
                    actualTab.className = "tab-content";
                    
                    actualTab.innerHTML = content;
                    info.appendChild(actualTab);
                    var tabHidden = true;
                    btn.onclick = () => {  
                       
                        allTabBtns.classList.add("backScreen")
                        allTabBtns.classList.remove("active")
                        allTabs.classList.add("active");
                        Array.from(allTabs.children).forEach(n=>{
                            n.classList.remove("active")

                        });
                        tab.classList.add("active");
                    
                    }

                    bck.onclick = () => {
                        allTabBtns.classList.remove("backScreen");
                        allTabBtns.classList.add("active");

                        allTabs.classList.remove("active");
                        
                        /*setTimeout(()=>{
                            tab.classList.remove("active")

                        }, 1000)*/
                        ;
                    }
                }

                

            </script>

    
        </div>
    </div>

    </div>
    </div>
</div>
</body>

</html>
