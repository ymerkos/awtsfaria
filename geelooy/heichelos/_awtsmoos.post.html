<!--B"H-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intense Post Viewer</title>
    <link rel="stylesheet" href="/heichelos/new-style.css" type="text/css">

</head>

<body>
    <h1>B"H</h1>
    
    <!-- Controls for Text Size -->
    <div class="controls">
        <button onclick="adjustFontSize('increase')" class="button">Increase Text Size</button>
        <button onclick="adjustFontSize('decrease')" class="button">Decrease Text Size</button>
    </div>

    
   <textarea class="hidden-post" id="postContent">
    <?Awtsmoos
        return post.content
    ?>
   </textarea>
    <div class="container">
        <div class="post">
            <h1 class="post-header"><?Awtsmoos
                return post.title
            ?></h1>
            <h4 class="post-author">Author: <a href="/@<?Awtsmoos
                return alias.id    
            ?>"><?Awtsmoos
                return alias.name
            ?></a></h4>
            <h4 class="post-heichel-name">Heichel Name: <a href="/heichelos/<?Awtsmoos
                return post.heichel.id
            ?>"><?Awtsmoos
                return post.heichel.name
            ?></a></h4>
            <?Awtsmoos
            //<script>
                var sr = $_GET.seriesParent;
                try {
                    var bp = $_GET.basepath;
                    
                    var seriesDetails = await fetchAwtsmoos(
                        `/api/social/heichelos/${
                            post.heichel.id
                        }/series/${
                            sr
                        }/`
                    );
                    sr = seriesDetails
                  
                    
                    return /*html*/`
                        <h3 class="post-parent-series">
                            Parent Series: <a href="/heichelos/${
                                post.heichel.id   
                            }/#?series=${
                                sr.id
                            }&path=${
                                encodeURIComponent(
                                    $_GET.path
                                )
                            }">${sr.prateem.name}</a>
                        </h3>
                    `
                } catch(e){
                    console.log(e)
                }
                return "ASDF"
            //</script>
            ?>
            <iframe class="post-frame">
                
            </iframe>
            
            <?Awtsmoos
                //<script>
                    var html = "";
                   // var cur =  parseInt($_GET.currentIndex);
                    var myID = post.id;
                    var sr = $_GET.seriesParent;
                
                    var posts = await fetchAwtsmoos(
                        `/api/social/heichelos/${
                            post.heichel.id
                        }/series/${
                            sr
                        }/posts`
                    );
                    var cur = posts.indexOf(myID);
                    var length = posts.length;
                    
                    var hasPrevious = cur > 0;
                    var hasNext = cur < length - 1;
                    var sr = $_GET.seriesParent;
                    
                    html +=/*html*/`
                        <div class="nav">
                    `

                    html+= /*html*/`
                        <div class="controls">${
                            cur + 1
                        } of ${
                            length
                        }    
                        </div>
                    `;
                    var last = encodeURIComponent(posts[cur-1]);
                    if(hasPrevious) {
                        html += /*html*/
                        `<a id="last" class="nav button" href="${last}">Previous</a>`
                    }

                    if(hasNext) {
                        var next = encodeURIComponent(posts[cur+1]);
                        html += /*html*/
                        `<a id="next" class="nav button"  href="${next}">Next</a>`
                    }

                    html += `</div>`;

                    html += /*html*/`
                        <script>

                            if(window.next) {
                                next.href = next.href+"?"
                                +(new URLSearchParams({
                                    currentIndex: "${cur+1}",
                                    path: "${$_GET.path}",
                                    seriesParent: "${$_GET.seriesParent}"
                                }));
                            }

                            if(window.last) {
                                last.href = last.href+"?"
                                    +(new URLSearchParams({
                                    currentIndex: "${cur-1}",
                                    path: "${$_GET.path}",
                                    seriesParent: "${$_GET.seriesParent}"
                                }));
                            }
                        </script>
                    `
                    return html;
                    
                
                //</script>
            ?>
            <script>
                
                console.log("B\"H")
                var frame = document.querySelector(".post-frame");
                if(frame) {
                    var frameJS = /*javascript*/`
                    (() => {
                        console.log("BH",
                        "from iframe!")
                        var commands = {
                            size: () => ({
                                size: {
                                    width: getAbsoluteWidth(document.documentElement),
                                    height:getAbsoluteHeight(document.documentElement)
                                }
                            }),
                            adjustFontSize: (cm) => {
                                adjustFontSize(cm);
                            }
                        };


                        window.onmessage = e => {
                            console.log("Doign!",e)
                            if(!e.data) {
                                return
                            }
                            if(!e.data.fromMain) {
                                return console.log("message not from main!")
                            }
                            var keys = Object.keys(e.data);
                            for(var ind in keys) {
                                var k = keys[ind]
                                var cm = commands[k];
                                console.log("cmnd",cm)
                                if(cm && typeof(cm) == "function") {
                                    var rs = cm(e.data[k]);
                                    if(rs) {
                                        try {
                                            window.parent.postMessage({
                                                [k]: rs
                                            }, "*")
                                        } catch(e) {
                                            console.log(e)
                                        }
                                    }
                                }
                            }
                            
                        }
                    
                        var MAX_FONT_SIZE = 45;  // Define the max font size
                        var MIN_FONT_SIZE = 10;  // Define the min font size
                        var FONT_SIZE_INCREMENT = 2; // Define the size increment
                        var postElement;
                        function adjustFontSize(action) {
                            if(!postElement)
                                postElement = document.querySelector('.content');
                            let currentFontSize = window.getComputedStyle(postElement, null).getPropertyValue('font-size');
                            currentFontSize = parseFloat(currentFontSize);
                        
                            if(action =='increase' && currentFontSize < MAX_FONT_SIZE) {
                                postElement.style.fontSize = (currentFontSize + FONT_SIZE_INCREMENT) + 'px';
                            } else if(action === 'decrease' && currentFontSize > MIN_FONT_SIZE) {
                                postElement.style.fontSize = (currentFontSize - FONT_SIZE_INCREMENT) + 'px';
                            }
                
                            localStorage.currentFontSize = currentFontSize;
                            sendSizeMessage()
                        }

                        function getAbsoluteHeight(el) {
                            // Get the DOM Node if you pass in a string
                            el = (typeof el === 'string') ? document.querySelector(el) : el; 

                            var styles = window.getComputedStyle(el);
                            var margin = parseFloat(styles['marginTop']) +
                                        parseFloat(styles['marginBottom']);
                            var scroll  = el.scrollWidth

                            return Math.max(
                                scroll+margin,
                                Math.ceil(el.offsetHeight + margin)
                            )
                        }

                        function getAbsoluteWidth(el) {
                            // Get the DOM Node if you pass in a string
                            el = (typeof el === 'string') ? document.querySelector(el) : el; 

                            var styles = window.getComputedStyle(el);
                            var margin = parseFloat(styles['marginLeft']) +
                                        parseFloat(styles['marginRight']);
                            var scroll  = el.scrollWidth

                            return Math.max(
                                scroll + margin,
                                Math.ceil(el.offsetWidth + margin)
                            );
                        }
                
                        function loadFontSize() {
                            var sz = localStorage.currentFontSize;
                            if(typeof(sz) == "string") {
                                sz = parseInt(sz);
                                if(!postElement)
                                    postElement = document.querySelector('.content');
                            
                                postElement.style.fontSize = sz + "px";
                                sendSizeMessage()
                            }
                        }

                        var self = this;
                
                        function sendSizeMessage() {
                            window.parent.postMessage({
                                size: {
                                    width: getAbsoluteWidth(document.documentElement),
                                    height:getAbsoluteHeight(document.documentElement)
                                }
                            }, "*")
                        }
                        onload = () => {
                            loadFontSize();
                        };
                    })();
                    
                
                    `;
                    var frameHtml = /*html*/`
                    <!--B"H-->
                    <!DOCTYPE html>
                    
                    <html lang="en">
                    <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
                    <link rel="stylesheet" href="https://awtsmoos.com/heichelos/new-style.css" type="text/css">
                    </head>
                    <body>
                        <div class="post">
                        <div class="content">
                        ${
                            postContent.value
                        }
                        </div>
                        
                        </div>
                        ${
                            "<script"+">"
                        }
                        ${frameJS}
                        ${
                            "</"+"script>"
                        }
                    </body>
                    </html>
                    
                    
                    `;
                    frame.src = URL.createObjectURL(
                        new Blob([
                            frameHtml
                        ], {
                            type: "text/html"
                        })
                    );
                    var loaded = false;
                    
                    //frame.contentWindow.document.body.innerHTML = frameHtml;
                    onmessage = e=> {
                        console.log(e.data, e, "A message!")
                       /* var src = e.target[0];
                        if(src !== frame.contentWindow) {
                            return console.log("Not from iframe")
                        }*/
                        if(e.data.fromMain) {
                            return console.log("From same window")
                        }
                        var d = e.data.size;
                        if(d) {
                            if(d.width) {
                                frame.style.width = d.width;

                            }
                            if(d.height) {
                                frame.style.height = d.height;
                            }
                            
                            console.log("Size!", d, frame, frame.style.width,frame.style.height)
                        }
                    };
                    frame.onload = () => {
                        if(!loaded) {
                            loaded = true
                        } else {
                            return;
                        }
                        frame.contentWindow.postMessage({
                            size: true,
                            fromMain: true
                        }, "*")
                    }
                }

                function adjustFontSize(cm) {
                    if(frame) {
                        frame.contentWindow.postMessage({
                            adjustFontSize: cm,
                            fromMain: true
                        }, "*")
                    }
                }
            </script>
        </div>
    </div>
    
    </script>
</body>

</html>
