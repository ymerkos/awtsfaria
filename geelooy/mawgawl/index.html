<!--B"H-->
<?Awtsmoos
    return $a("bh.html")
?>
<html>
<head>
    <link rel="stylesheet" href="./styles.css">
    
    
 


</head>
<body>
    <div class="month-selector">
        <select id="monthSelect">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
        <span id="year"></span>
    </div>
    <div id="calendar">
        <!-- Days will be added here -->
    </div>
    <div id="hoursPopup">
        <div id="closeButton">X</div>
        <!-- Hours will be added here -->
    </div>
    <div id="info"></div>
    <script>
        var currentYear = new Date().getFullYear();
        document.getElementById('year').innerText = currentYear;
        

        var selectedDay = null;
        var selectedHour = null;
    
        function createCalendar(month, year) {
            var date = new Date(year, month, 1);
            var daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear the calendar
            calendar.innerHTML = '';
            
            for (var i = 1; i <= daysInMonth; i++) {
                var day = document.createElement('div');
                day.className = 'day';
                day.innerText = i;
                // the rest of your day onclick function...
                day.onclick = function() {
                    // If selectedDay is this, toggle hoursPopup
                    if (this === selectedDay) {
                        var hoursPopup = document.getElementById('hoursPopup');
                        if (hoursPopup.style.display === 'none') {
                            displayHours();
                        } else {
                            hoursPopup.style.display = 'none';
                            if (selectedDay) {
                                selectedDay.classList.remove('selected');
                                selectedDay = null;
                            }
                        }
                    } else {
                        // Clear previous selection
                        if (selectedDay) {
                            selectedDay.classList.remove('selected');
                            selectedHour = null;
                        }
                        this.classList.add('selected');
                        selectedDay = this;
                        displayHours();
                    }
                }
                calendar.appendChild(day);
            }

            getBookings(month, year);
        }
        
        var monthSelect = document.getElementById('monthSelect');
        monthSelect.value = new Date().getMonth();
        monthSelect.onchange = function() {
            createCalendar(+this.value, currentYear);
        };
    


        function displayHours() {
            var hoursPopup = document.getElementById('hoursPopup');
            // Clear previous hours
            hoursPopup.innerHTML = '<div id="closeButton">X</div>';
    
            for (var j = 0; j < 24; j++) {
                var hour = document.createElement('div');
                hour.className = 'hour';
                // Create a new div for the hour text
var hourText = document.createElement('div');
hourText.className = 'hourText';
hourText.innerText = j + 1;
hour.appendChild(hourText);
                // New: add a div for the percentage bar
                var percentageBar = document.createElement('div');
                percentageBar.className = 'percentageBar';
                hour.appendChild(percentageBar);
                hour.onclick = function() {
                    if (selectedHour) {
                        selectedHour.classList.remove('selected');
                    }
                    this.classList.add('selected');
                    selectedHour = this;

                    // Show some information about the selected hour
                    document.getElementById('info').innerText = 'Selected day: ' + selectedDay.innerText + ', hour: ' + this.innerText;
                    
                    // Assume the user is logged in and wants to claim the whole hour
                    var request = new XMLHttpRequest();
                    request.open('POST', './', true); // Update '/backend' to your backend endpoint
                    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    var hourText = this.innerText; // Store the hour text in a variable
                    request.onreadystatechange = function() {
                        if (request.readyState == 4 && request.status == 200) {
                            
                            var response = {};
                            try {
                                response = JSON.parse(request.responseText);
                            } catch(e) {

                            }
                            
                            if (response.error) {
                                alert(response.error);
                            }else {
                                alert(response.success);
                                // If the booking was successful, mark the day and hour as booked
                                if(response.success) {
                                    if (selectedDay) {
                                        selectedDay.classList.add('booked');

                                    }
                                    if (selectedHour) {
                                        selectedHour.classList.add('booked');
                                        var perc = getPercentage([{minuteFrom:0,minuteTo:59}]);
                                        selectedHour.getElementsByClassName('percentageBar')[0]
                                        .style.width = perc+"%";
                                        console.log("perc",perc,selectedHour)
                                    }
                                }

                                if(response.deleted) {
                                    
                                    if (selectedHour) {
                                        selectedHour.classList.remove('booked');
                                        selectedHour.getElementsByClassName('percentageBar')[0]
                                        .style.width = 0 +"%";
                                    }
                                    
                                }

                                // Here update your bookings
                                // Depending on the structure of your data you might need to adjust this
                                const day = selectedDay.innerText;
                                const hour = hourText; // Use the stored hour text
                                
                                bookings = window.bookings || {};
                                if(response.deleted) {
                                    if(bookings[day]) {
                                        if(bookings[day][hourText+".json"]) {
                                            delete bookings[day][hourText+".json"];
                                            if(!Object.keys(bookings[day]).length) {
                                                delete bookings[day];
                                                if (selectedDay) {
                                                    selectedDay.classList.remove('booked');

                                                }
                                            }
                                        }
                                    } else {
                                        if (selectedDay) {
                                            selectedDay.classList.remove('booked');

                                        }
                                    }
                                } else {
                                    if(!bookings[day]) {
                                        bookings[day] = {};

                                    }
                                    if(!bookings[day][hourText+".json"]) {
                                        bookings[day][hourText+".json"] = []
                                    }
                                    bookings[day][hourText+".json"].push({
                                            minutesFrom:"0",
                                            minutesTo:"59"
                                    })
                                }
 
                                if (selectedDay && bookings) {
                                    var ar = []
                                    if(bookings[day])
                                    ar = Array.from(bookings[day]);
                                    if(!ar.length)
                                        selectedDay.classList.remove('booked');
                                }
                                if(!response.deleted)
                                // Refresh bookings highlight for the selected day
                                highlightBookings(getBookingsOfDay(day));
                            }
                        }
                    }
                    request.send(
                        'action=book&day=' + 
                        selectedDay.innerText + 
                        '&hour=' + hourText + 
                        "&year=" + year.innerText + 
                        "&month=" + monthSelect.value +
                        '&minuteFrom=0&minuteTo=59&recurring=false');
                }
                hoursPopup.appendChild(hour);
            }
    
            
            // Show popup
            hoursPopup.style.display = 'block';
    
            // Adjust position of the hoursPopup
            var rect = selectedDay.getBoundingClientRect();
            var popupWidth = hoursPopup.getBoundingClientRect().width;
            var windowWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            hoursPopup.style.top = (rect.top + window.scrollY + rect.height + 5) + "px"; // 5px for margin
            hoursPopup.style.left = Math.max(0, Math.min(rect.left + window.scrollX, windowWidth - popupWidth)) + "px";
    
            // Close button
            document.getElementById('closeButton').onclick = function() {
                document.getElementById('hoursPopup').style.display = 'none';
                if (selectedDay) {
                    selectedDay.classList.remove('selected');
                    selectedDay = null;
                }
            }
            // Call highlightBookings function for the selected day once all hours have been created
    
            if (selectedDay) {
                var bookingsForDayArray = bookings[selectedDay.innerText] || [];
                var bookingsForDay = bookingsForDayArray.reduce((acc, cur) => {
                    Object.keys(cur).forEach(key => {
                        if (acc[key]) {
                            acc[key].push(...cur[key]);
                        } else {
                            acc[key] = cur[key];
                        }
                    });
                    return acc;
                }, {});
                highlightBookings(bookingsForDay);
            }
        }


        function getBookingsOfDay(dayNumber) {
            // Retrieve the bookings for the specified day
            var bookingsForDay = bookings[dayNumber] || {};
            return bookingsForDay;
        }
        function getBookings(month, year) {
            var request = new XMLHttpRequest();
            request.open('POST', '/mawgawl/', true); // Update '/backend' to your backend endpoint
            request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200) {
                    var response;
                    
                    try { 
                        response = (JSON.parse(request.responseText));
                    }catch(e){}
                    console.log(response)
                    if(!response) return;
                    // Highlight booked days and hours
                    bookings=response
                    
                    highlightBookings(bookings);
                }
            }
            request.send('action=getBookings&month=' + month + '&year=' + year);
        }

        function highlightBookings(bookingsForDay) {
            var days = document.getElementsByClassName('day');
            var bookedDays = Object.keys(bookings); // Get booked days from bookings object

            for (var i = 0; i < days.length; i++) {
                var day = days[i];
                // If this day is in the list of booked days
                if (bookedDays.includes(day.innerText)) {
                    day.classList.add('booked');
                }
            }

            // New: add code to adjust the width of the percentage bars
            var hours = document.getElementsByClassName('hour');
            for (var i = 0; i < hours.length; i++) {
                var hour = hours[i];
                // Adjusted code to fit the new booking data structure
                var hourData = bookingsForDay[hour.innerText + ".json"];
                if (hourData) {
                    hour.classList.add("booked");
                    hour.querySelector('.hourText').innerText 
                      = (i+1)+" ("+hourData.length+")"
                    var percentageBooked = getPercentage(hourData);
                    hour.getElementsByClassName('percentageBar')[0].style.width = percentageBooked + '%';
                }
            }
        }

        function getPercentage(hourData) {
            var totalMinutesBooked = 0;
            for (var j = 0; j < hourData.length; j++) {
                var booking = hourData[j];
                totalMinutesBooked += booking.minuteTo - booking.minuteFrom;
            }
            var percentageBooked = totalMinutesBooked / 60 * 100;
            return percentageBooked;
        }

        function objectToList(object) {
            return Object.values(object).flat();
        }

        createCalendar(new Date().getMonth(), currentYear);



        //<?Awtsmoos
        if ($_POST['action'] == 'book') {
            olam.replace = true;
            if(!request.user) {
                return {error:"You're not even logged in!"};
            }
            // Extract booking details
            let year = $_POST['year'];
            let month = $_POST['month'];
            let day = $_POST['day'];
            let hour = $_POST['hour'];
            let minuteFrom = $_POST['minuteFrom'];
            let minuteTo = $_POST['minuteTo'];
            let recurring = $_POST['recurring'] === 'true';

            // Construct path for user's booking
            var yearBp = "bookings/" + year;
            var monthBp = yearBp + "/" + month
            var dayBookingPath = monthBp + "/" + day;
            var hourBookingPath = dayBookingPath + "/" + hour
            let bookingPath = hourBookingPath + "/" + request.user.info.userId;

            // Check if user already has a booking for this hour
            let existingBooking = await db.get(bookingPath);

            if (existingBooking !== null) {
                try {
                    var del = await db.delete(bookingPath);
                    console.log(del,bookingPath)

                    //check if hour folder is empty
                    var hours = await db.get(hourBookingPath);
                   
                    if(hours && hours.length == 0) {
                        await db.delete(hourBookingPath);
                    }

                    //same for day
                    var days = await db.get(dayBookingPath);
                   
                    if(days && days.length == 0) {
                        await db.delete(dayBookingPath);
                    }

                    //same for month
                    var months = await db.get(monthBp);
                   
                    if(months && months.length == 0) {
                        await db.delete(monthBp);
                    }

                    //same for years
                    var years = await db.get(yearBp);
                   
                    if(years && years.length == 0) {
                        await db.delete(yearBp);
                    }

                    
                    return {success: "Since you already had a booking" + 
                    " in that slot, you have just deleted it. Click again to re-book", deleted:1};
                } catch(e){
                    return { error: 'You have already booked this time slot.' };
                }
                
            }

            // Save the new booking to the database
            await db.create(bookingPath, { minuteFrom, minuteTo });

            return { success: 'Booking has been successfully created.' };
        }

        if ($_POST['action'] == 'getBookings') {
            olam.replace = true;
            let year = $_POST['year'] || null;
            let month = $_POST['month'] || null;
            let day = $_POST['day'] || null;
            let hour = $_POST['hour'] || null;

            if(year === null){
                // Handle error: year is required
                return {error: "Year is needed at least."}
            }

            // Construct the id
            let id = "bookings/" + year;
            if (month !== null) {
                id += "/" + month;
                if (day !== null) {
                    id += "/" + day;
                    if (hour !== null) {
                        id += "/" + hour;
                    }
                }
            } else {
                return {error: "Month is also needed at least."}
            }

            let dir = await db.get(id, true);
            
            let bookings = {};
            
            // Process the directory content, assuming it contains year/month/day/hour
            try {
                for (let day in dir) {
                    
                    bookings[day] = [];
                    
                    if(dir[day] && dir[day].forEach)
                    dir[day].forEach(hours => {
                        
                        var keysH = Object.keys(hours)

                        if(keysH && keysH.forEach)
                        keysH.forEach(hour => {
                            var hourOb = {
                                [hour+".json"]:[]
                            }
                            bookings[day].push(hourOb)
                            bookings[day][hour+".json"] = []
                            
                            var ar = Array.from(hours[hour])
                         
                            hours[hour].forEach(users => {
                                
                                
                                var keys = Object.keys(users)
                                
                                if(keys && keys.forEach)
                                keys.forEach(user => {
                                    
                                    if(users[user] && users[user].forEach)
                                    users[user].forEach(userInfo => { 
                                        hourOb[hour+".json"]
                                        .push({ minuteFrom: userInfo.minuteFrom, minuteTo: userInfo.minuteTo });
                                    })
                                })
                            })
                        })
                    })
                    
                }
            } catch(e) {
                console.log("Problem!",e)
            }
            
            return bookings;
        }
        //?>
    </script>
</body>
</html>
