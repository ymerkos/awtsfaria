<!--B"H-->
<?Awtsmoos
    return $a("bh.html")
?>
<html>
<head>
    <style>
        

        .percentageBar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 100%;
            width: 0%;  /* Default width */
            background-color: blue;
            opacity: 0.3;
        }
        .day {
            border: 1px solid #ddd;
            width: 100px;
            height: 100px;
            line-height: 100px;
            text-align: center;
            cursor: pointer;
            margin: 5px;
            float: left;
        }
        .day.selected {
            background-color: #eee;
        }

        .day.booked {
            background-color: red; /* Change as needed */
        }
        .hour {
            border: 1px solid #ddd;
            width: 50px;
            height: 50px;
            line-height: 50px;
            text-align: center;
            cursor: pointer;
            position: relative;
            margin: 2px;
            float: left;
        }
        .hour.selected {
            background-color: #eee;
        }
        #hoursPopup {
            display: none;
            position: fixed;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            background-color: white;
            border: 1px solid #ddd;
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        #closeButton {
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #info {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
        }

        .month-selector {
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .month-selector select, .month-selector span {
            margin: 0 10px;
            font-weight: bold;
            padding: 10px 20px;
            font-size: 20px;
            border: 2px solid #aaa;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .month-selector select {
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body>
    <div class="month-selector">
        <select id="monthSelect">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
        <span id="year"></span>
    </div>
    <div id="calendar">
        <!-- Days will be added here -->
    </div>
    <div id="hoursPopup">
        <div id="closeButton">X</div>
        <!-- Hours will be added here -->
    </div>
    <div id="info"></div>
    <script>
        var currentYear = new Date().getFullYear();
        document.getElementById('year').innerText = currentYear;
        

        var selectedDay = null;
        var selectedHour = null;
    
        function createCalendar(month, year) {
            var date = new Date(year, month, 1);
            var daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear the calendar
            calendar.innerHTML = '';
            
            for (var i = 1; i <= daysInMonth; i++) {
                var day = document.createElement('div');
                day.className = 'day';
                day.innerText = i;
                // the rest of your day onclick function...
                day.onclick = function() {
                    // If selectedDay is this, toggle hoursPopup
                    if (this === selectedDay) {
                        var hoursPopup = document.getElementById('hoursPopup');
                        if (hoursPopup.style.display === 'none') {
                            displayHours();
                        } else {
                            hoursPopup.style.display = 'none';
                            if (selectedDay) {
                                selectedDay.classList.remove('selected');
                                selectedDay = null;
                            }
                        }
                    } else {
                        // Clear previous selection
                        if (selectedDay) {
                            selectedDay.classList.remove('selected');
                            selectedHour = null;
                        }
                        this.classList.add('selected');
                        selectedDay = this;
                        displayHours();
                    }
                }
                calendar.appendChild(day);
            }

            getBookings(month, year);
        }
        
        var monthSelect = document.getElementById('monthSelect');
        monthSelect.value = new Date().getMonth();
        monthSelect.onchange = function() {
            createCalendar(+this.value, currentYear);
        };
    


        function displayHours() {
            var hoursPopup = document.getElementById('hoursPopup');
            // Clear previous hours
            hoursPopup.innerHTML = '<div id="closeButton">X</div>';
    
            for (var j = 0; j < 24; j++) {
                var hour = document.createElement('div');
                hour.className = 'hour';
                hour.innerText = j + 1;
                // New: add a div for the percentage bar
                var percentageBar = document.createElement('div');
                percentageBar.className = 'percentageBar';
                hour.appendChild(percentageBar);
                hour.onclick = function() {
                    if (selectedHour) {
                        selectedHour.classList.remove('selected');
                    }
                    this.classList.add('selected');
                    selectedHour = this;

                    // Show some information about the selected hour
                    document.getElementById('info').innerText = 'Selected day: ' + selectedDay.innerText + ', hour: ' + this.innerText;
                    
                    // Assume the user is logged in and wants to claim the whole hour
                    var request = new XMLHttpRequest();
                    request.open('POST', './', true); // Update '/backend' to your backend endpoint
                    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    var hourText = this.innerText; // Store the hour text in a variable
                    request.onreadystatechange = function() {
                        if (request.readyState == 4 && request.status == 200) {
                            
                            var response = {};
                            try {
                                response = JSON.parse(request.responseText);
                            } catch(e) {

                            }
                            
                            if (response.error) {
                                alert(response.error);
                            } else {
                                alert(response.success);
                                // If the booking was successful, mark the day and hour as booked
                                if (selectedDay) {
                                    selectedDay.classList.add('booked');
                                }
                                if (selectedHour) {
                                    selectedHour.classList.add('booked');
                                }

                                // Here update your bookings
                                // Depending on the structure of your data you might need to adjust this
                                const day = selectedDay.innerText;
                                const hour = hourText; // Use the stored hour text
                                const userId = "vv"; // Replace this with the real user id

                                if(!bookings[day]) {
                                    bookings[day] = [];
                                }

                                const currentHourBooking = bookings[day].find(item => Object.keys(item)[0] === `${hour}.json`);
                                
                                if(currentHourBooking) {
                                    currentHourBooking[`${hour}.json`].push([{"userId": userId, "minuteFrom": "0", "minuteTo": "59"}]);
                                } else {
                                    bookings[day].push({[`${hour}.json`]: [[{"userId": userId, "minuteFrom": "0", "minuteTo": "59"}]]});
                                }

                                // Refresh bookings highlight for the selected day
                                highlightBookings(getBookingsOfDay(day));
                            }
                        }
                    }
                    request.send(
                        'action=book&day=' + 
                        selectedDay.innerText + 
                        '&hour=' + hourText + 
                        "&year=" + year.innerText + 
                        "&month=" + monthSelect.value +
                        '&minuteFrom=0&minuteTo=59&recurring=false');
                }
                hoursPopup.appendChild(hour);
            }
    
            
            // Show popup
            hoursPopup.style.display = 'block';
    
            // Adjust position of the hoursPopup
            var rect = selectedDay.getBoundingClientRect();
            var popupWidth = hoursPopup.getBoundingClientRect().width;
            var windowWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            hoursPopup.style.top = (rect.top + window.scrollY + rect.height + 5) + "px"; // 5px for margin
            hoursPopup.style.left = Math.max(0, Math.min(rect.left + window.scrollX, windowWidth - popupWidth)) + "px";
    
            // Close button
            document.getElementById('closeButton').onclick = function() {
                document.getElementById('hoursPopup').style.display = 'none';
                if (selectedDay) {
                    selectedDay.classList.remove('selected');
                    selectedDay = null;
                }
            }
            // Call highlightBookings function for the selected day once all hours have been created
    
            if (selectedDay) {
                var bookingsForDayArray = bookings[selectedDay.innerText] || [];
                var bookingsForDay = bookingsForDayArray.reduce((acc, cur) => {
                    Object.keys(cur).forEach(key => {
                        if (acc[key]) {
                            acc[key].push(...cur[key]);
                        } else {
                            acc[key] = cur[key];
                        }
                    });
                    return acc;
                }, {});
                highlightBookings(bookingsForDay);
            }
        }


        function getBookingsOfDay(dayNumber) {
            // Retrieve the bookings for the specified day
            var bookingsForDayArray = bookings[dayNumber] || [];
            
            // Use reduce to combine all bookings for the day into one object
            var bookingsForDay = bookingsForDayArray.reduce((acc, cur) => {
                Object.keys(cur).forEach(key => {
                    if (acc[key]) {
                        acc[key].push(...cur[key]);
                    } else {
                        acc[key] = cur[key];
                    }
                });
                return acc;
            }, {});

            return bookingsForDay;
        }
        function getBookings(month, year) {
            var request = new XMLHttpRequest();
            request.open('POST', './', true); // Update '/backend' to your backend endpoint
            request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200) {
                    var response;
                    
                    try { 
                        response = (JSON.parse(request.responseText));
                    }catch(e){}
                    console.log(response)
                    if(!response) return;
                    // Highlight booked days and hours
                    bookings=response
                    
                    highlightBookings(bookings);
                }
            }
            request.send('action=getBookings&month=' + month + '&year=' + year);
        }

        function highlightBookings(bookingsForDay) {
            var days = document.getElementsByClassName('day');
            var bookedDays = Object.keys(bookings); // Get booked days from bookings object

            for (var i = 0; i < days.length; i++) {
                var day = days[i];
                // If this day is in the list of booked days
                if (bookedDays.includes(day.innerText)) {
                    day.classList.add('booked');
                }
            }

            // New: add code to adjust the width of the percentage bars
            var hours = document.getElementsByClassName('hour');
            for (var i = 0; i < hours.length; i++) {
                var hour = hours[i];
                // Adjusted code to fit the new booking data structure
                var hourData = bookingsForDay[hour.innerText + ".json"];
                if (hourData) {
                    var bookingsForHour = hourData[0];
                    if (bookingsForHour && bookingsForHour.length > 0) { 
                        var firstBooking = bookingsForHour[0]; 
                        var percentageBooked = (firstBooking.minuteTo - firstBooking.minuteFrom) / 60 * 100;
                        hour.getElementsByClassName('percentageBar')[0].style.width = percentageBooked + '%';
                    }
                }
            }
        }


        function objectToList(object) {
            return Object.values(object).flat();
        }

        createCalendar(new Date().getMonth(), currentYear);



        //<?Awtsmoos
        if ($_POST['action'] == 'book') {
            olam.replace = true;
            if(!request.user) {
                return {error:"You're not even logged in!"};
            }
            // Extract booking details
            let year = $_POST['year'];
            let month = $_POST['month'];
            let day = $_POST['day'];
            let hour = $_POST['hour'];
            let minuteFrom = $_POST['minuteFrom'];
            let minuteTo = $_POST['minuteTo'];
            let recurring = $_POST['recurring'] === 'true';

            // Get bookings for the given hour
            var b = await db.get("bookings/"+year+"/"+month + "/" + day + "/" + hour)
            console.log(b,213132,hour,day,month,year)
            let hourBookings = await db.get("bookings/" + year + "/" + month + "/" + day + "/" + hour) || [];
            console.log("Trying book",hourBookings)
            // Check if the user has already booked this time slot
            for (let booking of hourBookings) {
                
                if (booking.userId === request.user.info.userId) {
                    return { error: 'You have already booked this time slot.' };
                }
            }

            // Add the new booking
            hourBookings.push({ userId: request.user.info.userId, minuteFrom, minuteTo });

            // Save the bookings back to the database
            await db.create("bookings/" + year + "/" + month + "/" + day + "/" + hour, hourBookings);

            return { success: 'Booking has been successfully created.' };
        }

        
        /**
         * Get all bookings for a certain year, month, or day.
         * @param {string} year - The year for the bookings.
         * @param {string} [month] - The month for the bookings.
         * @param {string} [day] - The day for the bookings.
         * @returns {Promise<object[]>} - A Promise that resolves to a list of bookings.
         */
        
        if ($_POST['action'] == 'getBookings') {
            olam.replace = true;
            let year = $_POST['year'] || null;
            let month = $_POST['month'] || null;
            let day = $_POST['day'] || null;
            let hour = $_POST['hour'] || null;

            if(year === null){
                // Handle error: year is required
                return {error: "Year is needed at least."}
            }

            // Construct the id
            let id = "bookings/" + year;
            if (month !== null) {
                id = path.join(id, month);
                if (day !== null) {
                    id = path.join(id, day);
                    if (hour !== null) {
                        id = path.join(id, hour);
                    }
                }
            } else {
                return {error: "Month is also needed at least."}
            }

            let bookings = await db.get(id, true);
            console.log("Trying",id,year,bookings,month)
            return bookings;
        }

        //?>
    </script>
</body>
</html>