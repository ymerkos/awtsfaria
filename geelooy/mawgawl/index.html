<!--B"H-->
<?Awtsmoos
    return $a("bh.html")
?>
<html>
<head>
    <link rel="stylesheet" href="./styles.css">

</head>
<body>
    <div class="month-selector">
        <select id="monthSelect">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
        <span id="year"></span>
    </div>
    <div id="calendar">
        <!-- Days will be added here -->
    </div>
    <div id="hoursPopup">
        <div id="closeButton">X</div>
        <!-- Hours will be added here -->
    </div>
    <div id="minutesPopup">
        <div id="closeMinutesButton">X</div>
        <!-- Minutes will be added here -->
    </div>
    <div id="info"></div>
    <script src="./script.js"></script>
    <script>
        

        //<?Awtsmoos
        if ($_POST['action'] == 'book') {
            olam.replace = true;
            if(!request.user) {
                return {error:"You're not even logged in!"};
            }
            // Extract booking details
            let year = $_POST['year'];
            let month = $_POST['month'];
            let day = $_POST['day'];
            let hour = $_POST['hour'];
            let minuteFrom = $_POST['minuteFrom'];
            let minuteTo = $_POST['minuteTo'];
            let recurring = $_POST['recurring'] === 'true';

            // Construct path for user's booking
            var yearBp = "bookings/" + year;
            var monthBp = yearBp + "/" + month
            var dayBookingPath = monthBp + "/" + day;
            var hourBookingPath = dayBookingPath + "/" + hour
            let bookingPath = hourBookingPath + "/" + request.user.info.userId;

            // Check if user already has a booking for this hour
            let existingBooking = await db.get(bookingPath);

            if (existingBooking !== null) {
                try {
                    var del = await db.delete(bookingPath);
                    console.log(del,bookingPath)

                    //check if hour folder is empty
                    var hours = await db.get(hourBookingPath);
                   
                    if(hours && hours.length == 0) {
                        await db.delete(hourBookingPath);
                    }

                    //same for day
                    var days = await db.get(dayBookingPath);
                   
                    if(days && days.length == 0) {
                        await db.delete(dayBookingPath);
                    }

                    //same for month
                    var months = await db.get(monthBp);
                   
                    if(months && months.length == 0) {
                        await db.delete(monthBp);
                    }

                    //same for years
                    var years = await db.get(yearBp);
                   
                    if(years && years.length == 0) {
                        await db.delete(yearBp);
                    }

                    
                    return {success: "Since you already had a booking" + 
                    " in that slot, you have just deleted it. Click again to re-book", deleted:1};
                } catch(e){
                    return { error: 'You have already booked this time slot.' };
                }
                
            }

            // Save the new booking to the database
            await db.create(bookingPath, { minuteFrom, minuteTo });

            return { success: 'Booking has been successfully created.' };
        }

        if ($_POST['action'] == 'getBookings') {
            olam.replace = true;
            let year = $_POST['year'] || null;
            let month = $_POST['month'] || null;
            let day = $_POST['day'] || null;
            let hour = $_POST['hour'] || null;

            if(year === null){
                // Handle error: year is required
                return {error: "Year is needed at least."}
            }

            // Construct the id
            let id = "bookings/" + year;
            if (month !== null) {
                id += "/" + month;
                if (day !== null) {
                    id += "/" + day;
                    if (hour !== null) {
                        id += "/" + hour;
                    }
                }
            } else {
                return {error: "Month is also needed at least."}
            }

            let dir = await db.get(id, true);
            
            let bookings = {};
            
            // Process the directory content, assuming it contains year/month/day/hour
            try {
                for (let day in dir) {
                    
                    bookings[day] = [];
                    
                    if(dir[day] && dir[day].forEach)
                    dir[day].forEach(hours => {
                        
                        var keysH = Object.keys(hours)

                        if(keysH && keysH.forEach)
                        keysH.forEach(hour => {
                            var hourOb = {
                                [hour+".json"]:[]
                            }
                            bookings[day].push(hourOb)
                            bookings[day][hour+".json"] = []
                            
                            var ar = Array.from(hours[hour])
                         
                            hours[hour].forEach(users => {
                                
                                
                                var keys = Object.keys(users)
                                
                                if(keys && keys.forEach)
                                keys.forEach(user => {
                                    
                                    if(users[user] && users[user].forEach)
                                    users[user].forEach(userInfo => { 
                                        hourOb[hour+".json"]
                                        .push({ minuteFrom: userInfo.minuteFrom, minuteTo: userInfo.minuteTo });
                                    })
                                })
                            })
                        })
                    })
                    
                }
            } catch(e) {
                console.log("Problem!",e)
            }
            
            return bookings;
        }
        //?>
    </script>
</body>
</html>
