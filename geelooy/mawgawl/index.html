<!--B"H-->
<?Awtsmoos
    return $a("bh.html")
?>
<html>
<head>
    <link rel="stylesheet" href="./styles.css">

</head>
<body>
    <div class="month-selector">
        <select id="monthSelect">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
        <span id="year"></span>
    </div>
    <div id="calendar">
        <!-- Days will be added here -->
    </div>
    <div id="hoursPopup">
        <div id="closeButton">X</div>
        <!-- Hours will be added here -->
    </div>
    <div id="minutesPopup">
        <div id="closeMinutesButton">X</div>
        <!-- Minutes will be added here -->
    </div>
    <div id="info"></div>
    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modalMessage"></div>
        </div>
    </div>
    <script src="./script.js"></script>
    <script>
        

        //<?Awtsmoos
        //B"H
        /**
         * Server side code
         * @file This script handles the server-side operations for booking and getting bookings.
         * The booking action creates a booking for the given user. If the booking already exists,
         * it will delete it and return a message notifying the user. If it doesn't exist,
         * it will create a new one. The getBookings action fetches the booking details based
         * on the given parameters.
         *
         * @requires db - A database module to create, delete and get booking data.
         * @requires olam - Some olam module functionality is required in this script.
         * @requires request - The user request to get the user data.
         *
         * @example 
         * // Sample $_POST object for 'book' action
         * $_POST = {
         *     'action': 'book',
         *     'year': '2023',
         *     'month': '07',
         *     'day': '25',
         *     'hour': '18',
         *     'minuteFrom': '30',
         *     'minuteTo': '45',
         *     'recurring': 'true'
         * };
         *
         * // Sample $_POST object for 'getBookings' action
         * $_POST = {
         *     'action': 'getBookings',
         *     'year': '2023',
         *     'month': '07',
         *     'day': '25',
         *     'hour': '18'
         * };
         *
         * @returns {object} For 'book' action, it will return either:
         * - { success: 'Booking has been successfully created.' } if booking created successfully.
         * - { success: 'Since you already had a booking in that slot, you have just deleted it. Click again to re-book', deleted: 1 } if existing booking is deleted.
         * - { error: 'Error message' } in case of any error.
         * For 'getBookings' action, it will return an object containing bookings info, or { error: 'Error message' } in case of any error.
         */
        
         const validateRequestData = (data) => {
            if (!data.year || !data.month || !data.day || !data.hour || !data.minuteFrom || !data.minuteTo) {
                return false;
            }
            return true;
        };

        const deleteIfEmpty = async (path) => {
            let data = await db.get(path);
            if (data && data.length === 0) {
                await db.delete(path);
            }
        };

        const deleteExistingBooking = async (bookingPath, hourBookingPath, dayBookingPath, monthBp, yearBp) => {
            try {
                var del = await db.delete(bookingPath);

                await deleteIfEmpty(hourBookingPath);
                await deleteIfEmpty(dayBookingPath);
                await deleteIfEmpty(monthBp);
                await deleteIfEmpty(yearBp);

                return { success: "Since you already had a booking in that slot, you have just deleted it. Click again to re-book", deleted: 1 };
            } catch (e) {
                return { error: `Error while deleting booking: ${e.message}` };
            }
        };

        if ($_POST['action'] === 'book') {
            olam.replace = true;
            if (!request.user) {
                return { error: "You're not even logged in!" };
            }

            if (!validateRequestData($_POST)) {
                return { error: "Incomplete booking details." };
            }

            let { year, month, day, hour, minuteFrom, minuteTo, recurring } = $_POST;

            let yearBp = "bookings/" + year;
            let monthBp = yearBp + "/" + month
            let dayBookingPath = monthBp + "/" + day;
            let hourBookingPath = dayBookingPath + "/" + hour
            let bookingPath = hourBookingPath + "/" + request.user.info.userId;

            let existingBooking = await db.get(bookingPath);

            if (existingBooking && existingBooking.minuteFrom === minuteFrom && existingBooking.minuteTo === minuteTo) {
                return await deleteExistingBooking(bookingPath, hourBookingPath, dayBookingPath, monthBp, yearBp);
            }

            try {
                await db.create(bookingPath, { minuteFrom, minuteTo });
                return { success: 'Booking has been successfully created.' };
            } catch (e) {
                return { error: `Error while creating booking: ${e.message}` };
            }
        }



        if ($_POST['action'] === 'getBookings') {
            olam.replace = true;
            if (!$_POST['year'] || !$_POST['month']) {
                return { error: "Year and Month are needed at least." }
            }

            var currentUser = request.user ?
                request.user.info.userId : null;
            
            let { year, month, day, hour } = $_POST;

            let id = "bookings/" + year;
            id += "/" + month;

            if (day) {
                id += "/" + day;
                if (hour) {
                    id += "/" + hour;
                }
            }

            try {
                let dir = await db.get(id, true);
                let bookings = {};

                for (let day in dir) {
                    bookings[day] = {};

                    if (dir[day] && dir[day].forEach)
                        dir[day].forEach(hours => {
                            var keysH = Object.keys(hours)

                            if (keysH && keysH.forEach)
                                keysH.forEach(hour => {
                                    var hourKey = hour + ".json";
                                    bookings[day][hourKey] = [];

                                    var ar = Array.from(hours[hour])

                                    hours[hour].forEach(users => {
                                        var keys = Object.keys(users)

                                        if (keys && keys.forEach)
                                            keys.forEach(user => {

                                                if (users[user] && users[user].forEach)
                                                    users[user].forEach(userInfo => {
                                                        
                                                        var obj = { 
                                                                minuteFrom: 
                                                                userInfo.minuteFrom, 
                                                                minuteTo: userInfo.minuteTo 
                                                            };
                                                        if(
                                                            currentUser !== null &&
                                                            currentUser === user.replace(
                                                                ".json",""
                                                            )
                                                        ) {
                                                            obj.user = currentUser;
                                                        }
                                                        bookings[day][hourKey]
                                                            .push(obj);
                                                    })
                                            })
                                    })
                                })
                        })
                }

                return bookings;
            } catch (e) {
                return { error: `Problem while getting bookings: ${e.message}` };
            }
        }
        //?>
    </script>
</body>
</html>
